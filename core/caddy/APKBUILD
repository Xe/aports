# Contributor:
# Maintainer:
pkgname=caddy
pkgver=0.10.9
pkgrel=0
pkgdesc="Fast, cross-platform HTTP/2 web server with automatic HTTPS"
url="https://caddyserver.com"
arch="all"
license="Apache-2.0"
depends="ca-certificates gosu"
makedepends="go bash git"
install="$pkgname.pre-install"
pkgusers="$pkgname"
pkggroups="$pkgname"
subpackages="$pkgname-runit:runit"

githash=c4dfbb9956095c92d0586a52723748c070c7b459

source="
  run
	plugins.go
	$pkgname-$githash.tar.gz::https://codeload.github.com/mholt/caddy/tar.gz/$githash
	caddy.initd
	caddy.confd
	"

builddir="$srcdir/src/github.com/mholt/$pkgname"

prepare() {
        mkdir -p ${builddir%/*}
        export GOPATH="$srcdir"
        mv "$srcdir"/$pkgname-$githash "$builddir"/
        cp "$srcdir"/plugins.go "$builddir"/caddy/caddymain/plugins.go
        mkdir -p $srcdir/src/niichan.int/plugins
        cp "$srcdir"/plugins.go "$srcdir"/src/niichan.int/plugins
        cd "$builddir"
        default_prepare
}

build() {
        cd "$builddir"/caddy
        go get -v niichan.int/plugins/...
        go build -v -o caddy 
}

check() {
        "$builddir"/caddy/caddy -version > /dev/null
}

package() {
          cd "$builddir"

          install -Dm755 caddy/caddy "$pkgdir"/usr/sbin/caddy

	        # caddy currently does not support dropping privileges so we
	        # change attributes with setcat to allow access to priv ports
	        # https://caddyserver.com/docs/faq
	        setcap cap_net_bind_service=+ep \
		             "$pkgdir"/usr/sbin/caddy

         	install -d -o caddy -g caddy \
		              "$pkgdir"/var/lib/caddy \
		              "$pkgdir"/etc/caddy \
		              "$pkgdir"/var/www

	        install -Dm755 "$srcdir"/$pkgname.initd \
		              "$pkgdir"/etc/init.d/$pkgname
	        install -Dm644 "$srcdir"/$pkgname.confd \
		              "$pkgdir"/etc/conf.d/$pkgname
}

runit() {
        cd "$_builddir"
        pkgdesc="$pkgname runit bindings"
        depends="$pkgname runit"
        source="run"
        arch="noarch"

        install -D -m 755 "$srcdir"/run "$subpkgdir"/etc/service/$pkgname/run
}

sha512sums="4f9743b6698b2dcdd7438bd00892d3bd148bd4519510e4183ce44c1356e1631927602db4018640d62d45a41fc6737b9740479c4fc4fe1ce2377c13298aedb0ed  run
f70748bbc67984067fa112449713fca5d4571b6994aed666cc30aae090baba1d3fca8356b9176b41eb04b0bcbc56df24699bcac887cc2cc962aa3d893d1ee49c  plugins.go
6b51fb8bb6689ca15317a8c82d438636975698e900f251081147aab5366829e19c1e8b4710024480e169669c70550e4c802abe40c21fb1c8487025477be49516  caddy-c4dfbb9956095c92d0586a52723748c070c7b459.tar.gz
91dc46c48ca551979b32e59b232f0497285f00b376469552897e4fea2588678f8d0d764ff58fef530b9a282a6bd37be3b905ac7d014130329f58956cb23c58a1  caddy.initd
54a725606ae2087f53f4d18a1eda739bc8c38d05158bb7748ae7b747b06283ad84bc5607eb6b7a1e80cdf6a0f72e5b3765b307158d885dda0f003c4a55a4bc59  caddy.confd"
