# Contributor:
# Maintainer:
pkgname=caddy
pkgver=0.10.9
pkgrel=1
pkgdesc="Fast, cross-platform HTTP/2 web server with automatic HTTPS"
url="https://caddyserver.com"
arch="all"
license="Apache-2.0"
depends="ca-certificates"
makedepends="go bash git"
install="$pkgname.pre-install"
pkgusers="$pkgname"
pkggroups="$pkgname"

githash=545fa844bbd188c1e5bff6926e5c410e695571a0

source="
	plugins.go
	$pkgname-$githash.tar.gz::https://codeload.github.com/mholt/caddy/tar.gz/$githash
	caddy.initd
	caddy.confd
	"

builddir="$srcdir/src/github.com/mholt/$pkgname"

prepare() {
        mkdir -p ${builddir%/*}
        export GOPATH="$srcdir"
        mv "$srcdir"/$pkgname-$githash "$builddir"/
	cp "$srcdir"/plugins.go "$builddir"/caddy/caddymain/plugins.go
	mkdir -p $srcdir/src/niichan.int/plugins
	cp "$srcdir"/plugins.go "$srcdir"/src/niichan.int/plugins
        cd "$builddir"
        default_prepare
}

build() {
  cd "$builddir"/caddy
  go get -v niichan.int/plugins/...
  go build -v -o caddy 
}

check() {
	"$builddir"/caddy/caddy -version > /dev/null
}

package() {
	cd "$builddir"

	install -Dm755 caddy/caddy "$pkgdir"/usr/sbin/caddy

	# caddy currently does not support dropping privileges so we
	# change attributes with setcat to allow access to priv ports
	# https://caddyserver.com/docs/faq
	setcap cap_net_bind_service=+ep \
		"$pkgdir"/usr/sbin/caddy

	install -d -o caddy -g caddy \
		"$pkgdir"/var/lib/caddy \
		"$pkgdir"/etc/caddy \
		"$pkgdir"/var/www

	install -Dm755 "$srcdir"/$pkgname.initd \
		"$pkgdir"/etc/init.d/$pkgname
	install -Dm644 "$srcdir"/$pkgname.confd \
		"$pkgdir"/etc/conf.d/$pkgname
}

sha512sums="f70748bbc67984067fa112449713fca5d4571b6994aed666cc30aae090baba1d3fca8356b9176b41eb04b0bcbc56df24699bcac887cc2cc962aa3d893d1ee49c  plugins.go
9a4af75ed750cb0be5dae7ff6a5f88c2fd0c92c0acbebe89b61c490a12828b78c5ae73a4fc5934770e9395c0cda0a10472af9802e8e09219f3690526642f4eff  caddy-545fa844bbd188c1e5bff6926e5c410e695571a0.tar.gz
a0454e3d4c30b8eebb5e939dcbe7951ba3f6219772d78c8b5451acf54452bff73a6cc63f1214132e1231f40cd6fc3a46eb064b5ffb315b06e7631b664d5e751d  caddy.initd
54a725606ae2087f53f4d18a1eda739bc8c38d05158bb7748ae7b747b06283ad84bc5607eb6b7a1e80cdf6a0f72e5b3765b307158d885dda0f003c4a55a4bc59  caddy.confd"
